如何使用这个项目（只从这里的代码构建），如何打包发布，以及是否有现有的测试代码。


## 如何使用项目（从代码构建）

### 前置依赖

1. **Rust 工具链**：项目会自动下载（通过 `rust-toolchain.toml`，当前版本 1.92.0）
2. **protoc**：Protocol Buffers 编译器
   ```bash
   # Ubuntu/Debian
   sudo apt-get install protobuf-compiler
   
   # 验证安装
   protoc --version
   ```

### 主要构建命令

#### 最基本的构建方式（使用标准 cargo 命令）

这是最直接、最快速的构建方式，适用于快速编译和测试：

```bash
# 构建 debug 版本（开发用，包含调试信息）
cargo build

# 构建 release 版本（生产用，优化后的二进制文件）
cargo build --release

# 构建后，可执行文件位于：
# Debug:   target/debug/zellij
# Release: target/release/zellij

# 运行构建后的程序
./target/debug/zellij
# 或
./target/release/zellij

# 其他常用的标准 cargo 命令
cargo test              # 运行所有测试
cargo fmt               # 格式化代码
cargo fmt --check       # 检查代码格式（不修改）
cargo clippy            # 运行 Clippy 代码检查
cargo check             # 快速检查代码是否能编译（不生成二进制文件）
```

**注意**：使用 `cargo build` 时，默认插件可能不会自动构建。如果需要完整的构建（包括所有插件），建议使用下面的 `cargo xtask` 命令。

#### 使用项目自定义构建系统（推荐）

项目使用 `cargo xtask` 作为构建系统（无需额外安装，项目自带），提供更完整的构建流程：

```bash
# 格式化代码、构建、测试和运行 clippy（完整流程）
cargo xtask

# 单独执行各项操作
cargo xtask format      # 格式化代码
cargo xtask build        # 构建（debug 模式，包含所有插件）
cargo xtask build --release  # 构建（release 模式，包含所有插件）
cargo xtask test         # 运行测试
cargo xtask clippy       # 运行 Clippy 检查

# 运行 Zellij（调试模式）
cargo xtask run
cargo xtask run -l strider  # 使用指定布局运行

# 安装到指定目录
cargo xtask install /path/to/zellij/binary

# 快捷方式（xtask 可简写为 x）
cargo x build
cargo x test
cargo x run
```

#### 两种构建方式的区别

| 特性 | `cargo build` | `cargo xtask build` |
|------|---------------|-------------------|
| 速度 | 更快（只编译代码） | 较慢（包含额外步骤） |
| 插件构建 | 可能不完整 | 自动构建所有默认插件 |
| Protobuf 编译 | 自动处理 | 自动处理 |
| 资源文件 | 可能不完整 | 完整处理 |
| 适用场景 | 快速开发调试 | 完整构建、发布准备 |

### 构建流程说明

根据 `xtask/src/build.rs`，构建过程包括：
1. 编译 protobuf 定义文件（插件 API、客户端-服务器 IPC、Web 服务器）
2. 构建所有 workspace 成员（包括默认插件）
3. Release 模式下将插件移动到 assets 目录

## 如何打包发布

### 1. 创建发布包（Distribution）

```bash
# 创建发布包到 target/dist 目录
cargo xtask dist
```

这会执行：
- 构建 release 版本的插件和主程序
- 生成 manpage
- 将所有文件打包到 `target/dist/` 目录，包括：
  - `zellij` 可执行文件
  - `man/zellij.1` manpage
  - `zellij.desktop` 桌面文件
  - `logo.png` 图标

### 2. 安装到系统

```bash
# 安装到指定路径
cargo xtask install /usr/local/bin/zellij
```

### 3. 发布到 crates.io

```bash
# 发布所有 crate（需要先配置 cargo 认证）
cargo xtask publish

# 干运行（不实际发布）
cargo xtask publish --dry-run
```

发布流程（见 `xtask/src/pipelines.rs`）：
1. 清理项目
2. 构建 release 版本的插件
3. 更新默认配置
4. 创建 git commit 和 tag
5. 推送代码和 tag（除非使用 `--no-push`）
6. 依次发布所有 crate 到 crates.io

## 测试代码

### 单元测试

项目包含多个测试文件，主要分布在：

- `zellij-utils/src/ipc/tests/` - IPC 相关测试
- `zellij-utils/src/input/unit/` - 输入配置测试（theme_test.rs, layout_test.rs, keybinds_test.rs）
- `zellij-server/src/unit/` - 服务器单元测试
- `zellij-server/src/tab/unit/` - Tab 相关测试
- `zellij-server/src/panes/unit/` - 面板相关测试

运行测试：

```bash
# 运行所有测试
cargo xtask test

# 运行特定测试
cargo test --package zellij-server --lib

# 运行测试并传递参数
cargo xtask test -- --test-threads=1
```

### 端到端测试（E2E Tests）

项目包含端到端测试，通过 Docker 容器运行：

```bash
# 1. 启动 Docker 容器
docker-compose up -d

# 2. 构建 Linux 可执行文件（用于容器测试）
cargo xtask ci e2e --build

# 3. 运行端到端测试
cargo xtask ci e2e --test
```

**注意**：E2E 测试需要：
- `docker` 或 `podman`
- `docker-compose`
- `pkg-config` 和 `openssl`（用于某些测试）

### 测试相关配置

测试运行时会：
1. 先构建所有插件（`plugins_only: true`）
2. 然后对每个 workspace 成员运行 `cargo test`
3. 插件测试使用 `wasm32-wasip1` target

## 其他有用命令

```bash
# 生成 manpage（需要先安装 mandown: cargo install mandown）
cargo xtask manpage

# 查看所有可用命令
cargo xtask --help

# 清理构建产物
cargo clean              # 清理所有构建产物
cargo clean --release    # 只清理 release 构建产物

# 查看项目依赖
cargo tree               # 显示依赖树
cargo tree --depth 1     # 只显示直接依赖

# 更新依赖
cargo update             # 更新 Cargo.lock 中的依赖版本
```

## 项目结构说明

- `xtask/` - 自定义构建任务
- `zellij-client/` - 客户端代码
- `zellij-server/` - 服务器代码
- `zellij-utils/` - 工具库
- `default-plugins/` - 默认插件
- `assets/` - 资源文件（布局、配置、插件等）

以上信息基于项目代码和文档整理。